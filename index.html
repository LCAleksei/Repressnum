<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>性压抑指数计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pinyin@4.0.0/lib/umd/pinyin.js"></script>
    <script src="https://unpkg.com/wanakana@5.3.1/wanakana.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
        }
        .steel-text {
            background: linear-gradient(90deg, #a8a8a8, #d4d4d4, #a8a8a8, #858585, #a8a8a8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            background-size: 200% auto;
            animation: steel-shine 3s linear infinite;
        }
        @keyframes steel-shine {
            to { background-position: 200% center; }
        }
        .progress-bar-inner {
            transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1), background-color 0.8s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80% { transform: translateX(6px); }
        }
        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        @keyframes initial-fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .container-fade-in { animation: initial-fade-in 0.7s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; }
        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        .pop-in { animation: pop-in 0.5s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 8px rgba(100, 100, 100, 0.3), 0 0 12px rgba(100, 100, 100, 0.2); }
            50% { box-shadow: 0 0 16px rgba(100, 100, 100, 0.7), 0 0 24px rgba(100, 100, 100, 0.5); }
        }
        .pulsing-glow { animation: pulse-glow 1.5s infinite ease-in-out; }
        .lock-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.2em;
        }
        .language-selector {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 20;
        }
        .fixed-name-tag {
            display: inline-block;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 8px;
            vertical-align: middle;
        }
        .country-alert {
            background: linear-gradient(90deg, #1e40af, #1e3a8a);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            animation: fadeInUp 0.6s ease-out forwards;
        }
        .github-link {
            margin-top: 16px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        
        /* 新增动画样式 */
        @keyframes input-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.7); }
        }
        .input-glow { animation: input-glow 2s infinite ease-in-out; }
        
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: ripple 0.6s linear;
        }
        
        @keyframes card-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .card-float { animation: card-float 3s ease-in-out infinite; }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="language-selector">
        <select id="languageSelect" class="bg-gray-700 text-white py-2 px-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="zh-CN">中文</option>
            <option value="en-US">English</option>
            <option value="ja-JP">日本語</option>
            <option value="ko-KR">한국어</option>
            <option value="fr-FR">Français</option>
        </select>
    </div>

    <div class="fixed top-0 left-0 right-0 p-4 flex justify-between items-center z-10">
        <div class="relative">
            <button id="historyToggleBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 active:scale-95 shadow-lg">
                <span id="historyText">历史记录</span>
            </button>
            <div id="historyPanel" class="hidden mt-2 w-64 bg-gray-800 rounded-lg shadow-xl p-4 space-y-2 max-h-64 overflow-y-auto absolute left-0">
                <h3 class="text-lg font-semibold text-gray-300 mb-3" id="historyTitle">历史记录</h3>
                <ul id="historyList" class="space-y-2 text-sm text-gray-400">
                </ul>
                <button id="clearHistoryBtn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 active:scale-95 shadow-lg text-sm">
                    <span id="clearHistoryText">清除历史记录</span>
                </button>
                <p class="text-xs text-gray-500 mt-4" id="historyNote">我们不使用您输入的信息，结果仅供娱乐。</p>
            </div>
        </div>

        <div class="relative">
            <button id="shareButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 active:scale-95 shadow-lg hidden">
                <span id="shareText">分享</span>
            </button>
        </div>
    </div>

    <div class="w-full max-w-md mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6 container-fade-in">
        <div class="text-center">
            <h1 class="text-3xl font-bold steel-text" id="mainTitle">性压抑指数计算器</h1>
            <p class="text-gray-400 mt-2" id="subTitle">输入一个名字，看看"科学（并不）"的计算结果！</p>
            <p class="text-xs text-gray-500 mt-1" id="disclaimer">（纯属娱乐，请勿当真）</p>
        </div>

        <div class="space-y-4">
            <input type="text" id="nameInput" placeholder="输入任何名字或网名" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <button id="calculateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105 active:scale-95 shadow-lg relative overflow-hidden">
                <span id="btnText">开始计算</span>
                <span id="btnSpinner" class="hidden animate-spin">◐</span>
            </button>
        </div>

        <div id="resultSection" class="hidden pt-6 space-y-4 text-center">
            <h2 class="text-xl font-semibold text-gray-300 fade-in-up">
                <span id="resultForText">计算结果 for</span> "<span id="resultName" class="font-bold text-blue-400"></span>"
                <span id="fixedNameBadge" class="fixed-name-tag hidden">固定结果</span>
            </h2>
            
            <div class="relative w-full h-8 bg-gray-700 rounded-full overflow-hidden border-2 border-gray-600">
                <div id="progressBar" class="progress-bar-inner h-full rounded-full" style="width: 0%;"></div>
                <span id="percentageText" class="absolute inset-0 flex items-center justify-center text-sm font-bold text-white opacity-0">0%</span>
            </div>

            <p id="resultMessage" class="text-lg font-medium text-gray-200 min-h-16 flex items-center justify-center"></p>
            
            <div id="countryAlert" class="country-alert hidden">
                <span class="lock-icon">🔓</span>
                <span id="countryAlertText"></span>
            </div>
            
            <div id="githubLink" class="github-link text-gray-400 hidden">
                <span id="githubText">基于项目：</span>
                <a href="https://github.com/LCAleksei/Repressnum" target="_blank" id="githubUrl" class="text-blue-400 hover:text-blue-300 transition-colors duration-300">GitHub: LCAleksei/Repressnum</a>
            </div>
        </div>
    </div>

    <div class="fixed bottom-4 right-4 text-xs text-gray-600">
        <a href="#" class="hover:text-gray-500 transition-colors duration-300">
            <span id="footerText">仅供娱乐</span>
        </a>
    </div>

    <script>
        window.onload = function() {
            // HTML转义函数 - 防止XSS攻击
            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            const translations = {
                'zh-CN': {
                    history: '历史记录',
                    clearHistory: '清除历史记录',
                    historyNote: '我们不使用您输入的信息，结果仅供娱乐。',
                    share: '分享',
                    mainTitle: '性压抑指数计算器',
                    subTitle: '输入一个名字，看看"科学（并不）"的计算结果！',
                    disclaimer: '（纯属娱乐，请勿当真）',
                    placeholder: '输入任何名字或网名',
                    calculate: '开始计算',
                    resultFor: '计算结果 for',
                    footer: '仅供娱乐',
                    countryAlert: '性压抑已在{}传播！',
                    githubText: '基于项目：',
                    specialNames: {
                        '耄耋': { percentage: 100, message: '哈！', fixed: true },
                        'Minecraft': { percentage: 2009.0513, message: '你说得对，但是Minecraft是一款由Mojang Studios开发的沙盒类电子游戏', fixed: true },
                        'GitHub': { percentage: 100, message: 'Σ(っ °Д °;) っ', fixed: true },
                        'Terraria': { percentage: 2011.0516, message: '你说得对，但是泰拉瑞亚 是一款关于生存、冒险、创造 和肝硬化的游戏', fixed: true },
                        '田所浩二': { percentage: 114, message: '114514', fixed: true }
                    }
                },
                'en-US': {
                    history: 'History',
                    clearHistory: 'Clear History',
                    historyNote: 'We do not use your input information, results are for entertainment only.',
                    share: 'Share',
                    mainTitle: 'Repression Index Calculator',
                    subTitle: 'Enter a name to see the "scientific" result!',
                    disclaimer: '(For entertainment only)',
                    placeholder: 'Enter any name or nickname',
                    calculate: 'Calculate',
                    resultFor: 'Result for',
                    footer: 'For Entertainment Only',
                    countryAlert: 'Sexual repression has spread in {}!',
                    githubText: 'Based on project: ',
                    specialNames: {}
                },
                'ja-JP': {
                    history: '履歴',
                    clearHistory: '履歴をクリア',
                    historyNote: '入力された情報は使用せず、結果は娯楽目的のみです。',
                    share: '共有',
                    mainTitle: '性抑圧指数計算機',
                    subTitle: '名前を入力して「科学的」な結果を見てみましょう！',
                    disclaimer: '（娯楽目的のみ）',
                    placeholder: '任意の名前またはニックネームを入力',
                    calculate: '計算する',
                    resultFor: 'の結果',
                    footer: '娯楽のみ',
                    countryAlert: '性的抑圧が{}で広がっています！',
                    githubText: '基づくプロジェクト：',
                    specialNames: {}
                },
                'ko-KR': {
                    history: '기록',
                    clearHistory: '기록 지우기',
                    historyNote: '귀하의 입력 정보를 사용하지 않으며, 결과는 오락 목적으로만 제공됩니다.',
                    share: '공유',
                    mainTitle: '성 억압 지수 계산기',
                    subTitle: '이름을 입력하여 "과학적인" 결과를 확인하세요!',
                    disclaimer: '(오락 목적 전용)',
                    placeholder: '이름이나 닉네임을 입력하세요',
                    calculate: '계산하기',
                    resultFor: '결과 for',
                    footer: '오락 목적 전용',
                    countryAlert: '성적 억압이 {}에서 확산되고 있습니다!',
                    githubText: '기반 프로젝트：',
                    specialNames: {}
                },
                'fr-FR': {
                    history: 'Historique',
                    clearHistory: 'Effacer l\'historique',
                    historyNote: 'Nous n\'utilisons pas vos informations, les résultats sont uniquement à des fins de divertissement.',
                    share: 'Partager',
                    mainTitle: 'Calculateur d\'Indice de Répression',
                    subTitle: 'Entrez un nom pour voir le résultat "scientifique"!',
                    disclaimer: '(À des fins de divertissement uniquement)',
                    placeholder: 'Entrez un nom ou un pseudonyme',
                    calculate: 'Calculer',
                    resultFor: 'Résultat pour',
                    footer: 'À des fins de divertissement uniquement',
                    countryAlert: 'La répression sexuelle s\'est propagée en {}!',
                    githubText: 'Basé sur le projet: ',
                    specialNames: {}
                }
            };

            const countryMap = {
                'zh-CN': '中国',
                'en-US': 'United States',
                'ja-JP': '日本',
                'ko-KR': '韩国',
                'fr-FR': 'France'
            };

            const messageTiers = {
                0: [ 
                    "0%... 你是开放成精了吗？", "零压抑！你的世界里连彩虹都是彩色的吗？", "成分过纯，建议去夜店当DJ。", 
                    "比老子的支付宝余额还自由，令人羡慕。", "检测不到任何压抑迹象，程序可能出错了。", "你开放得像夏威夷的海滩，毫无遮掩。",
                    "修女见了你都得脸红，生怕被你带坏。", "你的生活里是不是只有'随心所欲'这条人生信条？", "你就是传说中的'解放天性'代言人本人。",
                    "你对'压抑'的唯一认知，可能就是字典里的那个词。", "毫无保留，毫无压抑，令人羡慕！", "你的情感表达如同瀑布般自然流畅。", "检测不到任何压抑迹象，活得真实！"
                ],
                20: [ 
                    "轻度压抑，偶尔会隐藏真实感受。", "像大多数人一样，有时会克制自己。", "你的情感表达基本自然，但偶尔会犹豫。", 
                    "小小的压抑，像微风中的一丝凉意。", "基本正常的情感表达，偶尔有所保留。", "你大脑里的'保守'区域，导航都搜不到。",
                    "如果开放能发电，你就是个永动机。", "你大概就是那种会问'为什么人要压抑自己'的人。", "你对性感的认知，就像Netflix一样丰富多彩。",
                    "你怕不是开放关系培训班里的课代表？"
                ],
                40: [ 
                    "中度压抑，时常隐藏真实情感。", "你的内心有一座小小的情感堤坝。", "习惯性地戴上社会期待的面具。", 
                    "像被轻轻锁住的情感，需要钥匙才能释放。", "你的情感像被修剪过的花园，整齐但受限。", "你以为你是开放的，其实你只是个有点保守的香蕉。",
                    "你的柜门开了一条缝，但你以为那是道德底线。", "看到性感的人，你会心想：'这身材真棒，可惜我不能表现出来'。", 
                    "你已经开始思考，为什么社会有那么多禁忌。", "你的性观念就像薛定谔的猫，不试探前谁也说不准。"
                ],
                60: [ 
                    "高度压抑，情感很少外露。", "你的内心有多重门锁，难以开启。", "习惯性地戴上社会期待的面具。", 
                    "情感像被严格管理的资源，很少放纵。", "你的表达方式像经过严格审核的文件。", "有点意思，你的保守雷达的指针动了一下。",
                    "已经开始对一些特定类型的欲望产生好奇了。", "你离解放天性，就差一个契机。", "嘴上说着不要，身体却很诚实。",
                    "是时候更新一下你的道德观念筛选器了。"
                ],
                80: [ 
                    "严重压抑，几乎从不表达真实情感。", "你的内心像上了多重锁的保险箱。", "情感被深埋，几乎从不外露。", 
                    "像生活在无形的笼子里，自我限制极强。", "你的情感表达像是经过层层过滤的净水。", "别装了，你的身体反应出卖了你！",
                    "性压抑雷达已经开始报警，只是声音比较小。", "你怕不是禁欲系的常驻嘉宾？", "说吧，你偷偷看过多少小黄书？",
                    "看到刺激的内容会心跳加速，但假装没看见。"
                ],
                90: [ 
                    "极度压抑，情感几乎完全封闭。", "你的内心像 fortress，难以攻破。", "情感被压缩到几乎不存在的地步。", 
                    "像是情感的苦行僧，极度克制自己。", "你的表达方式像是精密计算的机器。", "衣柜门都快关不住了吧！里面藏了多少秘密？",
                    "性压抑信号强度已爆表！", "下一步是不是就要立地成佛了？", "你压抑得像盘蚊香，还带锁的那种。",
                    "别点了，自己人，快开门！我们知道你在装！"
                ],
                100: [ 
                    "100%压抑！情感完全封闭！", "终极压抑大师！情感几乎不存在！", "你的内心像黑洞，吸收一切情感却不释放。", 
                    "情感被压缩到量子级别，几乎无法探测。", "你是情感压抑的终极形态！", "警报！已无需鉴定，天生的性冷淡！",
                    "你就是压抑本抑！", "恭喜！你已解锁'性压抑天花板'成就！", "压抑得彻底，连梦都是清心寡欲的。",
                    "出厂设置就是压抑的，别挣扎了。", "你不是性冷淡，你是性冷淡的CEO！", "性欲量表在你面前都得新增一个负维度。",
                    "你一张嘴，方圆十里的欲望都得瘫痪。", "别算了，快去寺庙报到当住持！", "你他妈的是不是从小被阉割了？怎么一点欲望都没有！",
                    "操，你这压抑程度连和尚都自愧不如！", "妈的，你是不是性功能有障碍啊？这么能憋！", "日，你这压抑水平可以去申请吉尼斯世界纪录了！",
                    "靠，你这样子是要修仙啊？完全不需要性生活？", "淦，你这压抑能力简直是人类进化史上的奇迹！"
                ]
            };

            const elements = {
                nameInput: document.getElementById('nameInput'),
                calculateBtn: document.getElementById('calculateBtn'),
                btnText: document.getElementById('btnText'),
                btnSpinner: document.getElementById('btnSpinner'),
                resultSection: document.getElementById('resultSection'),
                resultName: document.getElementById('resultName'),
                progressBar: document.getElementById('progressBar'),
                percentageText: document.getElementById('percentageText'),
                resultMessage: document.getElementById('resultMessage'),
                shareButton: document.getElementById('shareButton'),
                historyToggleBtn: document.getElementById('historyToggleBtn'),
                historyPanel: document.getElementById('historyPanel'),
                historyList: document.getElementById('historyList'),
                clearHistoryBtn: document.getElementById('clearHistoryBtn'),
                languageSelect: document.getElementById('languageSelect'),
                fixedNameBadge: document.getElementById('fixedNameBadge'),
                countryAlert: document.getElementById('countryAlert'),
                githubLink: document.getElementById('githubLink'),
                historyText: document.getElementById('historyText'),
                historyTitle: document.getElementById('historyTitle'),
                clearHistoryText: document.getElementById('clearHistoryText'),
                historyNote: document.getElementById('historyNote'),
                shareText: document.getElementById('shareText'),
                mainTitle: document.getElementById('mainTitle'),
                subTitle: document.getElementById('subTitle'),
                disclaimer: document.getElementById('disclaimer'),
                resultForText: document.getElementById('resultForText'),
                footerText: document.getElementById('footerText'),
                countryAlertText: document.getElementById('countryAlertText'),
                githubText: document.getElementById('githubText'),
                githubUrl: document.getElementById('githubUrl')
            };

            let typingInterval;
            let titleAnimationId;
            let currentLanguage = 'zh-CN';
            let originalTitle = document.title;

            // 添加按钮涟漪效果
            function createRipple(event) {
                const button = event.currentTarget;
                const circle = document.createElement("span");
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;

                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
                circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
                circle.classList.add("ripple");

                const ripple = button.getElementsByClassName("ripple")[0];
                if (ripple) ripple.remove();

                button.appendChild(circle);
            }

            // 更新浏览器标题动画
            function updateTitleAnimation(percentage, isFinalResult = false) {
                if (titleAnimationId) {
                    cancelAnimationFrame(titleAnimationId);
                }
                
                const t = translations[currentLanguage];
                const titlePrefix = t.mainTitle;
                
                function animateTitle() {
                    if (isFinalResult) {
                        document.title = `结果... ${percentage.toFixed(4)}% - ${titlePrefix}`;
                    } else {
                        document.title = `进度... ${percentage.toFixed(4)}% - ${titlePrefix}`;
                    }
                    
                    if (percentage < 100 && !isFinalResult) {
                        titleAnimationId = requestAnimationFrame(animateTitle);
                    } else if (isFinalResult) {
                        // 结果显示五秒后恢复正常
                        setTimeout(() => {
                            document.title = originalTitle;
                        }, 5000);
                    } else {
                        // 最终恢复原标题
                        setTimeout(() => {
                            document.title = originalTitle;
                        }, 2000);
                    }
                }
                
                animateTitle();
            }

            function setLanguage(lang) {
                currentLanguage = lang;
                const t = translations[lang];
                
                elements.historyText.textContent = t.history;
                elements.historyTitle.textContent = t.history;
                elements.clearHistoryText.textContent = t.clearHistory;
                elements.historyNote.textContent = t.historyNote;
                elements.shareText.textContent = t.share;
                elements.mainTitle.textContent = t.mainTitle;
                elements.subTitle.textContent = t.subTitle;
                elements.disclaimer.textContent = t.disclaimer;
                elements.nameInput.placeholder = t.placeholder;
                elements.btnText.textContent = t.calculate;
                elements.resultForText.textContent = t.resultFor;
                elements.footerText.textContent = t.footer;
                elements.githubText.textContent = t.githubText;
                
                localStorage.setItem('repressionLanguage', lang);
                renderHistory();
            }

            function encodeBase64(str) {
                return btoa(encodeURIComponent(str));
            }

            function decodeBase64(str) {
                try {
                    return decodeURIComponent(atob(str));
                } catch (e) {
                    return null;
                }
            }

            function saveHistory(name, percentage, message, isFixed = false) {
                // 转义用户输入以防止XSS
                const escapedName = escapeHtml(name);
                const escapedMessage = escapeHtml(message);
                
                let history = JSON.parse(localStorage.getItem('repressionHistory') || '[]');
                history.unshift({ 
                    name: escapedName, 
                    percentage, 
                    message: escapedMessage, 
                    isFixed, 
                    timestamp: new Date().toLocaleString(), 
                    language: currentLanguage 
                });
                if (history.length > 10) history = history.slice(0, 10);
                localStorage.setItem('repressionHistory', JSON.stringify(history));
                renderHistory();
            }

            function renderHistory() {
                const history = JSON.parse(localStorage.getItem('repressionHistory') || '[]');
                elements.historyList.innerHTML = '';
                
                if (history.length === 0) {
                    const emptyItem = document.createElement('li');
                    emptyItem.className = 'text-gray-500';
                    emptyItem.textContent = currentLanguage === 'zh-CN' ? '暂无历史记录' : 'No history yet';
                    elements.historyList.appendChild(emptyItem);
                    return;
                }
                
                history.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-2 bg-gray-700 rounded-md flex justify-between items-center cursor-pointer hover:bg-gray-600 transition duration-200';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'flex-grow min-w-0';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'font-semibold text-blue-300';
                    nameSpan.textContent = item.name;
                    
                    const percentageSpan = document.createElement('span');
                    percentageSpan.className = 'font-bold text-white';
                    percentageSpan.textContent = `: ${item.percentage}%`;
                    
                    const messageP = document.createElement('p');
                    messageP.className = 'text-xs text-gray-400 mt-1 truncate';
                    messageP.textContent = item.message;
                    
                    contentDiv.appendChild(nameSpan);
                    contentDiv.appendChild(percentageSpan);
                    contentDiv.appendChild(messageP);
                    
                    // 添加固定标签（如果需要）
                    if (item.isFixed) {
                        const fixedTag = document.createElement('span');
                        fixedTag.className = 'fixed-name-tag';
                        fixedTag.textContent = currentLanguage === 'zh-CN' ? '固定' : 'Fixed';
                        contentDiv.appendChild(fixedTag);
                    }
                    
                    const recallButton = document.createElement('button');
                    recallButton.className = 'recall-history text-blue-400 hover:text-blue-300 text-sm flex-shrink-0 whitespace-nowrap ml-2 px-3 py-1 rounded-md border border-blue-400 hover:bg-blue-700 transition duration-200';
                    recallButton.dataset.index = index;
                    recallButton.textContent = currentLanguage === 'zh-CN' ? '查看' : 'View';
                    
                    listItem.appendChild(contentDiv);
                    listItem.appendChild(recallButton);
                    
                    elements.historyList.appendChild(listItem);
                });
            }

            function recallHistoryItem(index) {
                const history = JSON.parse(localStorage.getItem('repressionHistory') || '[]');
                if (history[index]) {
                    const item = history[index];
                    elements.nameInput.value = item.name;
                    displayResult(item.name, item.percentage, item.message, item.isFixed);
                    elements.historyPanel.classList.add('hidden');
                }
            }

            function normalizeName(name) {
                let processedName = name.trim().toLowerCase();
                if (/[\u4e00-\u9fa5]/.test(processedName)) {
                    processedName = pinyin.pinyin(processedName, { style: pinyin.STYLE_NORMAL }).flat().join('');
                } else if (wanakana.isJapanese(processedName)) {
                    processedName = wanakana.toRomaji(processedName);
                }
                const letters = processedName.replace(/[^a-z]/g, '');
                const numbers = processedName.replace(/[^0-9]/g, '');
                const specials = processedName.replace(/[^a-z0-9]/g, '');
                return { letters, numbers, specials };
            }

            function getNumericValues(normalizedParts) {
                const letterValues = normalizedParts.letters.split('').map(char => char.charCodeAt(0) - 96);
                const numberSum = normalizedParts.numbers.split('').reduce((acc, digit) => acc + parseInt(digit, 10), 0);
                const specialSum = normalizedParts.specials.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                return { letterValues, numberSum, specialSum };
            }

            function repressionCalculation(values, originalName) {
                const { letterValues, numberSum, specialSum } = values;
                if (letterValues.length === 0 && numberSum === 0 && specialSum === 0) return 0;

                const t = translations['zh-CN'];
                const fixedNameKeys = Object.keys(t.specialNames);
                for (const key of fixedNameKeys) {
                    if (originalName.toLowerCase() === key.toLowerCase()) return t.specialNames[key].percentage;
                }

                const letterSum = letterValues.reduce((acc, val) => acc + val, 0);
                const letterAvg = letterValues.length > 0 ? letterSum / letterValues.length : 0;
                const numberFactor = numberSum % 9 === 0 ? 1.2 : 0.8;
                const specialFactor = 1 + (specialSum % 100) / 200;
                const lengthFactor = Math.min(originalName.length / 5, 2);
                let repressionScore = (letterAvg * 3 + numberSum * 0.7) * specialFactor * numberFactor;
                repressionScore = repressionScore * lengthFactor;
                const nameHash = simpleHash(originalName);
                const randomFactor = 0.9 + (nameHash % 20) / 100;
                repressionScore = repressionScore * randomFactor;
                let result = Math.min(100, Math.max(0, Math.round(repressionScore % 101)));
                return isNaN(result) ? 50 : result;
            }

            function simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0;
                }
                return Math.abs(hash);
            }

            function getResultMessage(percentage, name, isFixed = false) {
                if (isFixed) {
                    const t = translations['zh-CN'];
                    const fixedNameKeys = Object.keys(t.specialNames);
                    for (const key of fixedNameKeys) {
                        if (name.toLowerCase() === key.toLowerCase()) return t.specialNames[key].message;
                    }
                }

                let selectedTier;
                if (percentage === 0) selectedTier = messageTiers[0];
                else if (percentage <= 20) selectedTier = messageTiers[20];
                else if (percentage <= 40) selectedTier = messageTiers[40];
                else if (percentage <= 60) selectedTier = messageTiers[60];
                else if (percentage <= 80) selectedTier = messageTiers[80];
                else if (percentage <= 90) selectedTier = messageTiers[90];
                else selectedTier = messageTiers[100];

                const messageIndex = simpleHash(name + percentage) % selectedTier.length;
                return selectedTier[messageIndex];
            }
            
            function getProgressBarColor(percentage) {
                const colors = [ 
                    { p: 0, color: '#3b82f6' }, { p: 25, color: '#2563eb' }, 
                    { p: 50, color: '#1d4ed8' }, { p: 75, color: '#1e40af' }, 
                    { p: 100, color: '#1e3a8a' }
                ];
                for (let i = 1; i < colors.length; i++) {
                    if (percentage <= colors[i].p) {
                        const p1 = colors[i-1].p, p2 = colors[i].p;
                        const c1 = colors[i-1].color, c2 = colors[i].color;
                        const factor = (p2 - p1 === 0) ? 1 : (percentage - p1) / (p2 - p1);
                        const r1 = parseInt(c1.substring(1,3),16), g1 = parseInt(c1.substring(3,5),16), b1 = parseInt(c1.substring(5,7),16);
                        const r2 = parseInt(c2.substring(1,3),16), g2 = parseInt(c2.substring(3,5),16), b2 = parseInt(c2.substring(5,7),16);
                        const r = Math.round(r1 + factor * (r2-r1)), g = Math.round(g1 + factor * (g2-g1)), b = Math.round(b1 + factor * (b2-b1));
                        return `rgb(${r},${g},${b})`;
                    }
                }
                return colors[colors.length - 1].color;
            }

            function typeWriter(text, element, speed = 30) {
                clearInterval(typingInterval);
                element.textContent = '';
                let i = 0;
                typingInterval = setInterval(() => {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                    } else {
                        clearInterval(typingInterval);
                    }
                }, speed);
            }

            function displayResult(name, percentage, message, isFixed = false) {
                // 转义用户输入以防止XSS
                const escapedName = escapeHtml(name);
                const escapedMessage = escapeHtml(message);
                
                elements.resultName.textContent = escapedName;
                elements.resultSection.classList.remove('hidden');
                elements.shareButton.classList.remove('hidden');
                elements.resultMessage.textContent = '';
                elements.percentageText.textContent = '0%';
                elements.progressBar.style.width = '0%';
                elements.progressBar.style.backgroundColor = getProgressBarColor(0);
                elements.fixedNameBadge.classList.toggle('hidden', !isFixed);
                
                // 添加卡片浮现动画
                elements.resultSection.classList.add('pop-in');
                
                // 只有当进度≥100%时才显示国家传播提示
                if (percentage >= 100) {
                    const countryName = countryMap[currentLanguage];
                    const t = translations[currentLanguage];
                    const alertText = t.countryAlert.replace('{}', countryName);
                    elements.countryAlertText.textContent = alertText;
                    elements.countryAlert.classList.remove('hidden');
                    elements.countryAlert.classList.add('card-float'); // 添加浮动动画
                } else {
                    elements.countryAlert.classList.add('hidden');
                }
                
                elements.githubLink.classList.remove('hidden');
                
                // 启动浏览器标题动画
                updateTitleAnimation(0);
                
                let currentPercentage = 0;
                const increment = percentage / 50;
                const progressInterval = setInterval(() => {
                    currentPercentage += increment;
                    if (currentPercentage >= percentage) {
                        currentPercentage = percentage;
                        clearInterval(progressInterval);
                        
                        // 进度完成后显示完整消息
                        typeWriter(escapedMessage, elements.resultMessage, 50);
                        
                        // 添加轻微浮动动画到结果卡片
                        elements.resultSection.classList.add('card-float');
                    }
                    
                    // 根据数值决定是否显示小数点
                    if (currentPercentage % 1 === 0) {
                        elements.percentageText.textContent = `${Math.round(currentPercentage)}%`;
                    } else {
                        elements.percentageText.textContent = `${currentPercentage.toFixed(4)}%`;
                    }
                    elements.progressBar.style.width = `${currentPercentage}%`;
                    elements.progressBar.style.backgroundColor = getProgressBarColor(currentPercentage);
                    
                    // 更新浏览器标题动画
                    if (currentPercentage >= percentage) {
                        updateTitleAnimation(currentPercentage, true); // 传递 true 表示是最终结果
                    } else {
                        updateTitleAnimation(currentPercentage);
                    }
                    
                    if (currentPercentage > 20) {
                        elements.percentageText.style.opacity = '1';
                    }
                }, 20);
            }

            function calculateRepression() {
                const name = elements.nameInput.value.trim();
                if (!name) {
                    elements.nameInput.classList.add('shake');
                    setTimeout(() => elements.nameInput.classList.remove('shake'), 500);
                    return;
                }
                
                // 添加输入框微光效果
                elements.nameInput.classList.add('input-glow');
                setTimeout(() => elements.nameInput.classList.remove('input-glow'), 2000);
                
                elements.btnText.classList.add('hidden');
                elements.btnSpinner.classList.remove('hidden');
                
                setTimeout(() => {
                    const normalized = normalizeName(name);
                    const values = getNumericValues(normalized);
                    
                    const t = translations['zh-CN'];
                    const fixedNameKeys = Object.keys(t.specialNames);
                    let isFixed = false;
                    for (const key of fixedNameKeys) {
                        if (name.toLowerCase() === key.toLowerCase()) {
                            isFixed = true;
                            break;
                        }
                    }
                    
                    const percentage = repressionCalculation(values, name);
                    const message = getResultMessage(percentage, name, isFixed);
                    
                    displayResult(name, percentage, message, isFixed);
                    saveHistory(name, percentage, message, isFixed);
                    
                    elements.btnText.classList.remove('hidden');
                    elements.btnSpinner.classList.add('hidden');
                }, 1000);
            }

            // 事件监听器
            elements.calculateBtn.addEventListener('click', (e) => {
                createRipple(e);
                calculateRepression();
            });

            elements.nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    calculateRepression();
                }
            });

            elements.shareButton.addEventListener('click', () => {
                const name = elements.nameInput.value.trim();
                if (!name) return;
                
                const resultUrl = `${window.location.origin}${window.location.pathname}?name=${encodeURIComponent(name)}`;
                if (navigator.share) {
                    navigator.share({
                        title: translations[currentLanguage].mainTitle,
                        text: `${name}的性压抑指数计算结果`,
                        url: resultUrl
                    }).catch(() => {
                        navigator.clipboard.writeText(resultUrl).then(() => {
                            alert(currentLanguage === 'zh-CN' ? '链接已复制到剪贴板！' : 'Link copied to clipboard!');
                        });
                    });
                } else {
                    navigator.clipboard.writeText(resultUrl).then(() => {
                        alert(currentLanguage === 'zh-CN' ? '链接已复制到剪贴板！' : 'Link copied to clipboard!');
                    });
                }
            });

            elements.historyToggleBtn.addEventListener('click', () => {
                elements.historyPanel.classList.toggle('hidden');
            });

            elements.clearHistoryBtn.addEventListener('click', () => {
                localStorage.removeItem('repressionHistory');
                renderHistory();
            });

            elements.historyList.addEventListener('click', (e) => {
                if (e.target.classList.contains('recall-history')) {
                    const index = parseInt(e.target.dataset.index);
                    recallHistoryItem(index);
                }
            });

            elements.languageSelect.addEventListener('change', (e) => {
                setLanguage(e.target.value);
            });

            // 初始化
            const savedLanguage = localStorage.getItem('repressionLanguage');
            if (savedLanguage && translations[savedLanguage]) {
                elements.languageSelect.value = savedLanguage;
                setLanguage(savedLanguage);
            } else {
                setLanguage(currentLanguage);
            }

            const urlParams = new URLSearchParams(window.location.search);
            const nameParam = urlParams.get('name');
            if (nameParam) {
                elements.nameInput.value = decodeURIComponent(nameParam);
                calculateRepression();
            }

            renderHistory();
        };
    </script>
</body>
</html>
